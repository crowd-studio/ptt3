define(["jquery","globals","backbone","underscore","mustache","text!templates/upload-file-modal.mustache","bootstrap","markdown","to-markdown","bootstrap-markdown","asmselect"],function($,e,t,i,a,n){function o(e,t,i){return i.replace(new RegExp(e,"g"),t)}window.app={baseUrl:"/app_dev.php/",initialize:function(){var e=this;$.each($('textarea[data-type="markdown"]'),function(e){var t=new s({el:$(this)})}),$("div.alert:not(.persist)").delay(3e3).fadeOut(200),$("select[multiple]").asmSelect(),$(window).bind("resize",i.bind(this.resize,this)),$(".mobile-nav a").click(function(t){t.preventDefault(),e.toggleSidebar()}),$(".related-multiple-entities").each(function(){var e=new d({el:$(this)})}),$("div.preview").each(function(){var e=new l({el:$(this)})}),$('div[data-fieldtype="map"] .map').each(function(){var e=new r({el:$(this)})}),$('div[data-fieldtype="panel"]').each(function(){var e=new p({el:$(this)})}),$(".btn-alert-button").click(function(e){e.preventDefault(),confirm($(this).attr("data-alert"))&&(window.location=$(this).attr("href"))}),$("div.camera").each(function(){var e=new c({el:$(this)})}),$("form.edit").submit(function(e){return $(this).hasClass("processing")?!1:void 0}),$("form.disabled").each(function(){$(this).find("input,select,textarea,.btn:not(.btn-link)").addClass("disabled").attr("disabled","disabled")})},resize:function(){this.showSidebar(!1)},toggleSidebar:function(){this.showSidebar($(".sidebar").hasClass("hidden-xs"))},showSidebar:function(e){e?($(".sidebar").removeClass("hidden-xs"),$(".main").addClass("hidden-xs"),$("body").addClass("nav-active")):($(".sidebar").addClass("hidden-xs"),$(".main").removeClass("hidden-xs"),$("body").removeClass("nav-active"))}};var s=t.View.extend({events:{},initialize:function(e){"undefined"==typeof e&&(e={}),i.extend(this,i.pick(e));var t=i.isUndefined(this.$el.attr("data-height"))?300:this.$el.attr("data-height"),a=this;this.$el.markdown({autofocus:!1,savable:!1,height:t,additionalButtons:[[{name:"groupCustom",data:[{name:"cmdUploadImage",toggle:!1,title:"Upload file",icon:"glyphicon glyphicon-upload",callback:function(e){a.callback(e)}}]}]]})},callback:function(e){var t=a.to_html(n,{});$("body").append($(t).attr("id","modal-upload-file")),$("#modal-upload-file").modal("show"),$("#modal-upload-file div.btn-group div").click(function(){$("#modal-upload-file div.btn-group div.active").removeClass("active"),$(this).addClass("active")}),$("#modal-upload-file").on("hidden.bs.modal",function(){$("#modal-upload-file").remove()}),$("#modal-upload-file form").submit(function(t){var i=this;t.preventDefault();var a=$(this).find("#file")[0].files;if(a.length>0){$(this).addClass("loading");for(var n=new FormData,o=0;o<a.length;o++){var s=a[o];s.type.match("image.*")&&n.append("files[]",s,s.name)}var d=$("#modal-upload-file div.btn-group div.active"),l=d.attr("data-width"),r=d.attr("data-height");n.append("width",l),n.append("height",r);var c=new XMLHttpRequest;c.open("POST",window.app.baseUrl+$(i).attr("action"),!0),c.onload=function(t){if(200===c.status){var t=JSON.parse(t.target.response),a="!["+$(i).find("#description").val()+"]("+t.resized+")";e.replaceSelection(a),e.setSelection(e.getSelection(),e.getSelection()+a.length),$("#modal-upload-file").modal("hide")}else $(i).removeClass("loading"),alert("An error occurred! Please, try again!")},c.send(n)}else alert("You must select a file!")})}}),d=t.View.extend({events:{"click .btn.add":"add","click .btn.remove":"remove"},initialize:function(){"undefined"==typeof options&&(options={}),i.extend(this,i.pick(options))},add:function(e){e.preventDefault();var t=this.$el.find("div.entity.clone").clone().removeClass("hidden clone"),i=this.$el.find("div.entity:not(.clone)").length;t.html(o("-1",i+1,t.html())),this.$el.find(".btn.add").before(t)},remove:function(e){e.preventDefault(),confirm("Proceed with deletion?")&&$(e.currentTarget).parent().remove()}}),l=t.View.extend({events:{"click .btn.remove-image":"remove"},initialize:function(){"undefined"==typeof options&&(options={}),i.extend(this,i.pick(options))},remove:function(e){e.preventDefault(),confirm("Proceed with file deletion?")&&($(e.currentTarget).parent().fadeOut(300,function(){$(this).find('input[type="file"]').remove()}),$(e.currentTarget).parent().find('input[type="hidden"]').val(1))}}),r=t.View.extend({events:{"click .search":"search","keydown .address":"addressSearch"},initialize:function(){"undefined"==typeof options&&(options={}),i.extend(this,i.pick(options)),this.initializeMap()},initializeMap:function(){this.geocoder=new google.maps.Geocoder;var e=new google.maps.LatLng(41.386999,2.170032),t=[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}],i={zoom:16,center:e,styles:t};this.map=new google.maps.Map(this.$el.find(".map-canvas")[0],i);var a=this;google.maps.event.addListener(this.map,"click",function(e){a.addPin(e.latLng,!1)}),this.addDefaultAddress()},addDefaultAddress:function(){if(this.$el.find("input.coordinates").val().length>0){var e=this.$el.find("input.coordinates").val().split("/");if(2==e.length){var t=new google.maps.LatLng(parseFloat(e[0]),parseFloat(e[1]));this.addPin(t,!0)}}},addressSearch:function(e){"undefined"!=typeof e.which&&13==e.which&&this.search(e)},search:function(e){e.preventDefault();var t=this;this.geocoder.geocode({address:this.$el.find(".address").val()},function(e,i){i==google.maps.GeocoderStatus.OK?t.addPin(e[0].geometry.location,!0):alert("There was an error: "+i)})},addPin:function(e,t){"undefined"!=typeof this.marker&&this.marker.setMap(null),this.marker=new google.maps.Marker({map:this.map,position:e});var i=e.lat()+"/"+e.lng();this.$el.find("input.coordinates").val(i),t&&this.map.setCenter(e)}}),c=t.View.extend({events:{"click a.showWebcam":"toggle","click a.snapPicture":"snap"},firstTime:!0,pictureTaken:!1,initialize:function(){"undefined"==typeof options&&(options={}),i.extend(this,i.pick(options))},toggle:function(e){e.preventDefault(),this.$el.find(".camera-preview").toggleClass("active"),this.$el.find(".camera-preview").hasClass("active")&&this.firstTime&&this.startCamera()},startCamera:function(){this.firstTime=!1;var e=this.$el.find("canvas")[0],t=e.getContext("2d"),i=this.$el.find("video")[0],a={video:!0},n=function(e){console.log("Video capture error: "+e.code)};this.video=i,this.canvas=e,this.context=t,navigator.getUserMedia?navigator.getUserMedia(a,function(e){i.src=e,i.play()},n):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(a,function(e){i.src=window.webkitURL.createObjectURL(e),i.play()},n):navigator.mozGetUserMedia&&navigator.mozGetUserMedia(a,function(e){i.src=window.URL.createObjectURL(e),i.play()},n)},snap:function(e){if(e.preventDefault(),this.$el.find("video").toggleClass("hidden"),this.$el.find("canvas").toggleClass("hidden"),!this.pictureTaken){this.context.drawImage(this.video,0,0,800,600);var t=this;$("form.edit").addClass("processing"),$.ajax({type:"POST",url:window.app.baseUrl+t.$el.attr("data-url"),data:{canvas:"yes",imgBase64:t.canvas.toDataURL(),sizes:JSON.parse(this.$el.attr("data-sizes"))}}).done(function(e){t.$el.find('input[type="hidden"]').val(e.filename),$("form.edit").removeClass("processing")})}this.pictureTaken=!this.pictureTaken}}),p=t.View.extend({events:{"click button.btn.btn-default":"selectDay"},initialize:function(){"undefined"==typeof options&&(options={}),i.extend(this,i.pick(options))},selectDay:function(e){e.preventDefault();var t=this.$el.find("div.btn-group button.btn").index(e.toElement);$(e.toElement).toggleClass("active");var a=this.$el.find('input[type="hidden"]').val().split("");i.isUndefined(a[t])||(a[t]="0"==a[t]?1:0),this.$el.find('input[type="hidden"]').val(a.join(""))}});return window.app});